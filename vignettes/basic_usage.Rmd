---
title: "Basic Usage"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{basic_usage}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(CBEA)
library(phyloseq)
library(tidyverse, quietly = TRUE)
library(BiocSet)
```

## Loading sample data  
First, we can load some pre-packaged data sets contained in `CBEA`. Here we're loading the `phyloseq` version of the same data set. The `CBEA` package also supports `TreeSummarizedExperiment` objects, where the equivalent data set can be loaded via the command `data("hmp_gingival_treesum")`        
```{r load_data}
data("hmp_gingival_physeq")
abun <- hmp_gingival_treesum$data
sets <- hmp_gingival_treesum$set
```

## Constructing sets from taxonomic tables  
Taxonomic sets are custom collections of microbes and associated annotations pre-determined. There are various ways to think about constructing sets, and the most common type of sets used are based on taxonomic ranks. We can construct these sets using a convenient function `const_set`:  

```{r const_set_rank, eval = TRUE}
genus_sets <- const_set(abun, rank = "FAMILY")
genus_sets
```
The construction of sets using the `const_set` function also attaches the size of the set. Using this metadata and convenient functions associated with the `BiocSet` data container, we can filter out small sets. We can see that the total number of sets and element sets have decreased since the filter.  
```{r trim_sets, eval = TRUE}
genus_sets <- genus_sets %>% BiocSet::filter_set(size >= 10)
```

CBEA accepts any type of sets, as long as it is in the `BiocSet` format where the elements in the sets can be matched to taxa currently in the data container of choice (`phyloseq` or `TreeSummarizedExperiment`). Users can attach any type of metadata to sets as they wish. 

## Applying CBEA   

`cbea` requires an object of type `phyloseq`, `TreeSummarizedExperiment`, `matrix`, or `data.frame`. For `matrix` and `data.frame` classes, it is required that taxa are columns and sample are rows. For other data containers there is an automated procedure to perform the transpose and correct for these issues. Additionally, if there are zeros in the abundance data, the `cbea` will add a pseudocount to avoid issues with the log-ratio transformation (but will throw a warning). If a different zero-handling approach is desired, users should pre-process the abundance data with the appropriate method.  

Applying `cbea` is one command:  
```{r run_cbea, eval = TRUE}
results <- cbea(abun, set = genus_sets, output = "cdf", distr = "norm", adj = TRUE, thresh = 0.05)
head(results)
```

There are various arguments to control the behaviour of CBEA. The most important arguments include the format of the output (CDF, z-scores, p-values or merely whether it is significant - controlled by threshold argument `thresh`), the form of the null distribution (normal or mixture normal), and whether correlation adjustment is required. The procedure relies on the `fitdistrplus` and `mixtools` packages to estimate the parameters of the null. Specific arguments to control this fitting procedure can be provided as a named list in the `control` argument. 

## Session Info 
```{r session-info, eval=TRUE, echo=FALSE}
sessionInfo()
```



